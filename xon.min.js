!function(global){"use strict";if("undefined"==typeof Proxy){console.error("XON: Proxy not supported in this browser");return}let isProblematicBrowser=/chrome|chromium/i.test(navigator.userAgent);isProblematicBrowser&&console.warn("XON: Running in simplified mode for stability");let xon={version:"2.3",debug:!0,path:"",api:"",loaded:{js:[],css:[],component:new Set},reactivity:{},registry:{},parser:{},binder:{},template:{},router:{},dom:{},security:{},by:t=>document.querySelector(t),byAll:t=>document.querySelectorAll(t),byId:t=>document.getElementById(t),byClass:t=>document.getElementsByClassName(t),byTag:t=>document.getElementsByTagName(t),init(){("localhost"===location.hostname||"127.0.0.1"===location.hostname)&&xon.template.cache.clear(),xon.registry.init(),xon.router.init(),xon.debug.log("XON initialised ‚Äì modules ready"),this.render()},render(t=null){if(t){let n="string"==typeof t?document.querySelector(t):t;n?(console.log(`üéØ Rendering XON for selector: ${t}`),xon.parser.renderElement(n)):console.warn(`‚ùå Element not found for selector: ${t}`)}else console.log("\uD83C\uDFAF Rendering all XON elements"),xon.parser.render()},demoComputedProperties(){this.reactivity.demo()},testMemoization(){this.reactivity.testMemo()},debugComputedProperties(){this.reactivity.debugComputed()}};xon.debug={enabled:!0,log(...t){this.enabled&&console.log("[XON]",...t)},warn(...t){console.warn("[XON]",...t)},error(...t){console.error("[XON]",...t)},toggle(t){this.enabled=!!t}},xon.security={allowed:new Set(["xon","xonry","utils","app","lib"]),dangerous:new Set(["eval","Function","execScript","write","writeln","alert","confirm","prompt","setTimeout","setInterval"]),dangerousPatterns:[/\.innerHTML$/,/\.outerHTML$/,/\.src$/i,/\.href$/i,/^setTimeout$/,/^setInterval$/,/\.__proto__/,/\.constructor/],isSafe(t){let n=t.split(".")[0];return this.allowed.has(n)},sanitizeJSCode:function(t){return"string"!=typeof t?"":t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/\//g,"&#47;").replace(/\\/g,"&#92;").replace(/\n/g,"<br>").replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;").replace(/ /g,"&nbsp;")},loadFromScriptTag:function(t,n){if(!n){xon.debug.warn(`No target element provided for script tag fallback: ${t}`);return}let r=t.includes("."),l=r?[t,t.replace(".html",""),t.replace(".php",""),t.replace(".htm","")]:[t,t+".html",t+".htm"];for(let a of l){let i=document.getElementById(a);if(i&&("text/html"===i.type||"text/template"===i.type)){xon.debug.log(`Loading from script tag fallback: ${a}`);let o=this.sanitizeHTML(i.innerHTML);n.innerHTML=o,r||xon.parser.renderElement(n);return}}xon.debug.warn(`No script tag fallback found for: ${t}`),n.innerHTML=`<div class="error-message">‚ùå File not found: ${t}</div>`},sanitizeTextContent:function(t){return"string"!=typeof t?"":t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/\n/g,"<br>").replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;").replace(/  /g," &nbsp;")},isDangerous(t){return!!this.dangerous.has(t)||this.dangerousPatterns.some(n=>n.test(t))},sanitizeHTML:function(t){if("string"!=typeof t)return"";let n=document.createElement("div");return n.innerHTML=t,this.removeDangerousElements(n),this.removeDangerousAttributes(n),n.innerHTML},removeDangerousElements:function(t){["script","iframe","object","embed","form","input","button","select","textarea","meta","link","base","applet","frame","frameset","marquee","video","audio","source","track","canvas","svg","math"].forEach(n=>{let r=t.getElementsByTagName(n);for(;r.length>0;)r[0].parentNode.removeChild(r[0])});let n=t.getElementsByTagName("*");for(let r=0;r<n.length;r++){let l=n[r];this.removeDangerousAttributes(l)}},removeDangerousAttributes:function(t){let n=/^(on\w+|style|src|href|action|formaction)$/i,r=/^(javascript:|vbscript:|data:|fscommand:)/i;for(let l=t.attributes.length-1;l>=0;l--){let a=t.attributes[l];(n.test(a.name)||r.test(a.value))&&t.removeAttribute(a.name)}},allowedHTMLTags:["div","span","p","h1","h2","h3","h4","h5","h6","ul","ol","li","table","tr","td","th","thead","tbody","tfoot","br","hr","strong","em","b","i","u","s","blockquote","code","pre"],allowedAttributes:["class","id","title","alt","width","height","colspan","rowspan","align","valign","border","cellpadding","cellspacing"]},xon.reactivity=function(){let t=new Map,n=new Map,r=new Map,l=new Map,a=null,i=0,o=new Set,s=(t,r="")=>{if(t?.__isReactive)return t;let l=new Proxy(t,{get(t,l,i){let o=Reflect.get(t,l,i);if(a){let u=n.get(r)||{effects:new Set,computed:new Set};u.effects.add(a),n.set(r,u)}return o&&"object"==typeof o&&!o.__isReactive?s(o,`${r}.${l}`):o},set(t,n,l,a){let i=t[n],o=Reflect.set(t,n,l,a);return i!==l&&u(r,n),o}});return l.__isReactive=!0,l.__path=r,l},u=(t,l)=>{xon.debug.log(`[REACT] Change: ${t}.${l}`);let a=n.get(t);a&&(a.effects.forEach(t=>g(t)),a.computed.forEach(t=>r.get(t)?._invalidate())),xon.binder.triggerTemplate(t,l)},g=t=>i?o.add(t):t(),c=()=>{o.forEach(t=>t()),o.clear()};return{createState(n,r){let l=s(r,n);return t.set(n,l),global[n]=l,global[`$${n}`]=l,xon.registry.registerVariable(n,l),l},createStateWithComputed(t,n,r={}){let l=this.createState(t,n);return Object.entries(r).forEach(([t,n])=>{let r=this.computed(t,()=>n.call(l));Object.defineProperty(l,t,{get:()=>r.value,enumerable:!0,configurable:!0})}),l},computed(t,n){let l,i=!0,o={get value(){if(i||void 0===l){let s=a;a=o,l=n(),a=s,i=!1}return l},_invalidate(){i=!0}};return r.set(t,o),o},memo(t,n,r=5e3){let a=JSON.stringify(t),i=Date.now(),o=l.get(a);if(o&&i-o.ts<r)return o.v;let s=n();return l.set(a,{v:s,ts:i}),s},clearCache(t=null){t?l.delete(JSON.stringify(t)):l.clear()},track(t){a=t,t(),a=null},batch(t){i++;try{t()}finally{0==--i&&c()}},demo(){let t=this.createStateWithComputed("demoState",{price:100,quantity:2,taxRate:.1,items:[{name:"A",price:50},{name:"B",price:75}]},{subtotal(){return this.price*this.quantity},tax(){return this.subtotal*this.taxRate},total(){return this.subtotal+this.tax},expensiveItems(){return this.items.filter(t=>t.price>60)},itemCount(){return this.items.length},averagePrice(){return this.items.length?this.items.reduce((t,n)=>t+n.price,0)/this.items.length:0}});global.demoState=t,console.log("Demo state:",t),t.price=150,console.log("After price change:",t.subtotal,t.total)},testMemo(){let t=0,n=(n,r)=>{t++;for(let l=0;l<1e6;l++);return n*r};console.log(this.memo("k1",()=>n(5,10))),console.log(this.memo("k1",()=>n(5,10))),console.log(this.memo("k2",()=>n(3,7))),console.log("Computations:",t)},debugComputed(){console.log("Computed:",[...r.keys()]),r.forEach((t,n)=>console.log(`${n}:`,t.value)),console.log("Cache size:",l.size)}}}(),xon.registry=function(){let funcs=new Map,vars=new Map,classes=new Map,skip=t=>/^_|^#|^__|\__|webkit|moz|ms|Symbol|Proxy|Reflect|Weak|Map|Set|Promise|Generator|Async|Atomics|SharedArrayBuffer|DataView|eval|Function|alert|confirm|prompt|localStorage|sessionStorage|indexedDB|history|location|navigator|screen|performance|length|name|prototype|constructor|\d+$/.test(t),safeFunc=(path,fn)=>{let name=path.split(".").pop();return!xon.security.dangerous.has(name)&&fn!==eval&&fn!==Function&&(!!xon.security.isSafe(path)||!/eval|Function|script|write|cookie|storage/i.test(path))},scanObj=(t,n="",r=0,l=new WeakSet)=>{if(r>5||l.has(t))return;for(let a of(l.add(t),[...Object.getOwnPropertyNames(t),...Object.getOwnPropertySymbols(t).map(t=>t.toString())])){if(skip(a))continue;let i=n?`${n}.${a}`:a,o;try{o=t[a]}catch{continue}"function"==typeof o?safeFunc(i,o)&&(funcs.set(i,o),/^[A-Z]/.test(a)&&classes.set(i,o)):"object"!=typeof o||null===o?vars.set(i,o):xon.security.isSafe(i)&&scanObj(o,i,r+1,l)}let s=Object.getPrototypeOf(t);s&&s!==Object.prototype&&s!==Function.prototype&&scanObj(s,`${n}.__proto__`,r+1,l)};return{init(){scanObj(window),["Array","String","Object","Number","Date","Math","JSON"].forEach(t=>scanObj(window[t],t)),xon.debug.log("Registry init ‚Äì funcs:",funcs.size,"vars:",vars.size)},registerFunction(t,n){"function"!=typeof n||xon.security.isDangerous(t)||funcs.set(t,n)},registerVariable(t,n){vars.set(t,n)},registerClass(t,n){"function"==typeof n&&(classes.set(t,n),funcs.set(t,n))},getFunction:t=>funcs.get(t),getVariable:t=>vars.get(t),getClass:t=>classes.get(t),listFunctions:()=>[...funcs.keys()],listVariables:()=>[...vars.keys()],listClasses:()=>[...classes.keys()]}}(),xon.parser=function(){let t=t=>{let n=t.match(/^(%!?)([\w]+)(?:~>([\s\S]+))?$/);if(!n)return null;let[,r,l,a]=n;return{type:"templateDirective",templateName:l,priority:!!r,target:a?a.trim():null}},n=t=>{let n=/(@\w+#[\w\/.-]+~>[^~]+~\/[^\s]+)|(@\w+~\/[^\s]+)|(@\w+#[\w\/.-]+~>[^\s]+)|(@\w+#[\w\/.-]+)|(@\w+\$[a-zA-Z_][a-zA-Z0-9_]*\.[a-zA-Z0-9_]+(\+\+|--))|(@\w+%%!?[\w\/.-]+(?:~>[^~\s]+)?)|(@\w+%%[\w\/.-]+(?:~>[^~\s]+)?)|(@\w+%[\w\/.-]+(?:~>[^~\s]+)?)|(@[\w-]+\$[^~>\s]+(?:\([^)]*\))?(?:~>[^~\s]+)?)|(@[\w-]+#[^~>\s]+(?:~>[^~\s]+)?)|(#[\w\/.-]+(?:~>[^~\s]+)?)|(\$[\w]+\([^)]*\)(?:~>[^~\s]+)?)|(%!?%?[\w\/.-]+(?:\([^)]*\))?(?:~>[^~\s]+)?)|(@[\w-]+&[\w-]+(?:~>[^~\s]+)?)|(~\/[^\s]+)/g,l=[],a=0,i;for(;null!==(i=n.exec(t));){if(i.index>a){let o=t.slice(a,i.index);l.push(...r(o))}l.push(i[0].trim()),a=i.index+i[0].length}if(a<t.length){let s=t.slice(a);l.push(...r(s))}return l.filter(t=>t.trim())},r=t=>t.split(/\s+/).filter(t=>t.trim()),l=(t,n=null)=>{let r=t.match(/^@(\w+)#([\w\/.-]+)~>([^~\s]+)~\/$/);if(r){let[,l,a,i]=r;return console.log("‚úÖ INCLUDE WITH HREF ROUTE detected (deferred href extraction):",{event:l,includeFile:a,target:i,element:n?.tagName}),{type:"event",event:l,includeFile:a,target:i.trim(),functionCall:null,functionArgs:[],templateName:null,templateTarget:null,isFormTemplate:!1,isStateAssignment:!1,routePath:null,needsHrefExtraction:!0}}let o=t.match(/^@(\w+)#([\w\/.-]+)~>([^~\s]+)(?=~\/|$)/);if(o){let[,s,u,g]=o;return console.log("‚úÖ INCLUDE WITH TARGET detected:",{event:s,includeFile:u,target:g}),{type:"event",event:s,includeFile:u,target:g.trim(),functionCall:null,functionArgs:[],templateName:null,templateTarget:null,isFormTemplate:!1,isStateAssignment:!1,routePath:null}}let c=t.match(/^@(\w+)#([\w\/.-]+)$/);if(c){let[,d,p]=c;return console.log("‚úÖ INCLUDE EVENT detected:",{event:d,includeFile:p}),{type:"event",event:d,includeFile:p,target:null,functionCall:null,functionArgs:[],templateName:null,templateTarget:null,isFormTemplate:!1,isStateAssignment:!1,routePath:null}}let m=t.match(/^@(\w+)~(\/[^\s]*)$/);if(m){let[,f,h]=m;return console.log("‚úÖ ROUTE EVENT detected:",{event:f,routePath:h}),{type:"event",event:f,routePath:"~"+h,functionCall:null,functionArgs:[],includeFile:null,target:null,templateName:null,templateTarget:null,isFormTemplate:!1,isStateAssignment:!1}}let b=t.match(/^@(\w+)#([\w\/.-]+)~>([^~]+)~(\/[^\s]+)$/);if(b){let[,y,T,v,w]=b;return console.log("‚úÖ COMPLEX ROUTE SYNTAX detected:",{event:y,includeFile:T,target:v,routePath:w}),{type:"event",event:y,includeFile:T,target:v.trim(),routePath:"~"+w,functionCall:null,functionArgs:[],templateName:null,templateTarget:null,isFormTemplate:!1,isStateAssignment:!1}}let N=t.match(/^@(\w+)\$([a-zA-Z_][a-zA-Z0-9_]*\.[a-zA-Z0-9_]+)(\+\+|--)$/);if(N){let[,E,A,x]=N;return console.log("‚úÖ INCREMENT OPERATION detected:",{event:E,stateProperty:A,operator:x}),{type:"event",event:E,functionCall:A,functionArgs:[x],isStateAssignment:!0,isIncrement:!0,statePropertyPath:A,assignmentType:"increment"}}let P=t.match(/^@(\w+)\$([a-zA-Z_][a-zA-Z0-9_]*\.[a-zA-Z0-9_.]+)\(([^)]*)\)$/);if(P){let[,S,C,$]=P;return console.log("‚úÖ STATE ASSIGNMENT detected:",{event:S,stateProperty:C,stateValue:$}),{type:"event",event:S,functionCall:C,functionArgs:[$],includeFile:null,routePath:null,target:null,templateName:null,templateTarget:null,isFormTemplate:!1,isStateAssignment:!0,statePropertyPath:C}}let L=t.match(/^@(\w+)%%(!?)([\w]+)(?:~>([^~\s]+))?$/);if(L){let[,F,M,_,k]=L;return console.log("‚úÖ FORM TEMPLATE PARSED:",{event:F,templateName:_,target:k,priority:!!M}),{type:"event",event:F,templateName:_,templateTarget:k?k.trim():null,isFormTemplate:!0,functionCall:null,functionArgs:[],includeFile:null,routePath:null,target:null,priority:!!M}}let B=t.match(/^@(\w+)%(!?)([\w]+)(?:~>([^~\s]+))?$/);if(B){let[,O,H,R,I]=B;return console.log("‚úÖ SIMPLE TEMPLATE event detected:",{event:O,templateName:R,target:I,priority:!!H}),{type:"event",event:O,templateName:R,templateTarget:I?I.trim():null,isFormTemplate:!1,functionCall:null,functionArgs:[],includeFile:null,routePath:null,target:null,priority:!!H}}if(t.includes("%%")){console.log("\uD83D\uDD04 Manual fallback parsing for %% syntax");let q=t.split("%%");if(2===q.length){let D=q[0].replace("@",""),j=q[1],W=j.match(/^(!?)([\w]+)(?:~>([\s\S]+))?$/);if(W){let[,z,U,J]=W;return console.log("‚úÖ MANUAL FORM TEMPLATE PARSED:",{event:D,templateName:U,target:J,priority:!!z,rawTemplatePart:j}),{type:"event",event:D,templateName:U,templateTarget:J?J.trim():null,isFormTemplate:!0,functionCall:null,functionArgs:[],includeFile:null,routePath:null,target:null,priority:!!z}}}}let X=t.match(/^@(\w+)(?:\$([\w.]+)(?:\(([^)]*)\))?)?(?:\#([\w.-]+))?(?:%([\w!]+)(?:~>([^~]+))?)?(?:~>([^~]+))?(?:~(\/[^\s]+))?$/);if(!X)return xon.debug.warn(`‚ùå Failed to parse event token: ${t}`),null;let[,G,V,Z,K,Y,Q,ee,et]=X;console.log("\uD83C\uDFAF Complex regex match results:",{event:G,functionCall:V,functionArgs:Z,includeFile:K,templateName:ee,templateTarget:et,routePath:Q});let en=!1,er=null;V&&V.startsWith("state.")&&(en=!0,er=V,console.log("\uD83D\uDD0D Detected state assignment:",er));let ea={type:"event",event:null,functionCall:null,functionArgs:[],includeFile:null,routePath:null,target:null,templateName:null,templateTarget:null,isFormTemplate:!1};xon.debug.log("Regex match results:",{event:G,functionCall:V,functionArgs:Z,includeFile:K,routePath:Q,target:Y,templateName:ee,templateTarget:et});let ei=t.match(/^@(\w+)/);if(!ei)return xon.debug.warn(`No event found in: ${t}`),null;ea.event=ei[1];let eo=t.slice(ei[0].length),es=eo.match(/^%%([\w!]+)(?:~>([\s\S]+))?/);es&&(ea.templateName=es[1],ea.templateTarget=es[2]?es[2].trim():null,ea.isFormTemplate=!0,eo=eo.slice(es[0].length),console.log("\uD83D\uDD0D Found FORM template:",ea.templateName));var eu=eo.match(/^%([\w!]+)(?:~>([\s\S]+))?/);eu&&!ea.templateName&&(ea.templateName=eu[1],ea.templateTarget=eu[2]?eu[2].trim():null,eo=eo.slice(eu[0].length),console.log("\uD83D\uDD0D Found regular template:",ea.templateName));var eu=eo.match(/^%([\w!]+)(?:~>([\s\S]+))?/);eu&&(ea.templateName=eu[1],ea.templateTarget=eu[2]?eu[2].trim():null,eo=eo.slice(eu[0].length),console.log("\uD83D\uDD0D Found template in event:",ea.templateName,"target:",ea.templateTarget));let eg=eo.match(/^\$([\w.]+)(?:\(([^)]*)\))?/);eg&&(ea.functionCall=eg[1],eg[2]&&(ea.functionArgs=eg[2].split(",").map(t=>t.trim())),eo=eo.slice(eg[0].length));let ec=eo.match(/^~>([\s\S]+)/);return ec&&(ea.target=ec[1].trim()),xon.debug.log("Manually parsed event:",ea),ea},a=t=>{let n=t.match(/^#([\w\/.-]+)(?:~>([\s\S]+))?$/);if(!n)return xon.debug.warn(`Failed to parse include token: ${t}`),null;let[,r,l]=n,a={type:"include",file:r,target:l?l.trim():null};return xon.debug.log("Parsed include:",a),a},i=t=>{let n=t.match(/^~(\/[^\s]+)$/);if(!n)return null;let[,r]=n;return{type:"route",path:r}},o=t=>{let n=t.match(/^\$([\w]+)(?:\(([^)]*)\))?(?:~>([^~\s]+(?:\s+[^~\s]+)*))?$/);if(!n)return xon.debug.warn(`Failed to parse function token: ${t}`),null;let[,r,l,a]=n,i={type:"function",funcName:r,args:l?l.split(",").map(t=>t.trim()):[],target:a?a.trim():null};return xon.debug.log("Parsed function:",i),i},s=t=>{let n=t.match(/^(%!?%?)([\w]+)(?:\(([^)]*)\))?(?:~>([\s\S]+))?$/);if(!n)return null;let[,r,l,a,i]=n;return{type:"template",templateName:l,priority:r.includes("!"),formData:"%%"===r,templateArgs:a?a.split(",").map(t=>t.trim()):[],target:i?i.trim():null}},u=t=>{let n=t.match(/^@(\w+)&(\w+)(?:~>([\s\S]+))?$/);if(!n)return null;let[,r,l,a]=n;return{type:"eventTrigger",sourceEvent:r,triggerEvent:l,target:a?a.trim():null}},g=t=>{let n=t.match(/^:(\w+)$/);if(!n)return null;let[,r]=n;return{type:"binding",bindingType:r}},c=(t,n,r)=>{window._xonBindings||(window._xonBindings=[]),window._xonBindings.push({state:t,statePath:n,target:r});let l=m(t,n),a=document.querySelectorAll(r);a.forEach(t=>{t.textContent=l}),console.log("\uD83D\uDD17 Auto-binding setup:",n,"‚Üí",r)},d=t=>{let n=t.getAttribute("data-xon");if(!n?.trim().startsWith("{"))return console.log("‚ùå Not a JSON object"),null;try{let r=n.trim();console.log("\uD83D\uDD0D JSON text before parse:",r);let l=JSON.parse(r);return console.log("‚úÖ JSON parse successful:",l),l}catch(a){console.error("‚ùå JSON parse error:",a),console.log("Error at position:",a.position);try{console.log("\uD83D\uDD04 Trying direct parse without cleaning...");let i=JSON.parse(n);return console.log("‚úÖ Direct parse successful:",i),i}catch(o){return console.error("‚ùå Direct parse also failed:",o),null}}},p=function(t,n){if(t._xonProcessed){console.warn("\uD83D\uDEA8 DUPLICATE JSON PROCESSING - SKIPPING");return}if(t._xonProcessed=!0,n&&n.$state){let r="state",l=xon.reactivity.createState(r,n.$state);if(window[r]=l,console.log("‚úÖ State created:",r,l),n.$bind){var a,i;a=l,i=n.$bind,window.bind={},Object.entries(i).forEach(([t,n])=>{window.bind[t]=n,window._xonBindings||(window._xonBindings=[]),window._xonBindings.push({state:a,statePath:t,target:n});let r=m(a,t),l=document.querySelectorAll(n);l.forEach(t=>{t.textContent=r})}),window.bind=new Proxy(window.bind,{set(t,n,r){console.log("\uD83D\uDD17 Bind updated:",n,"‚Üí",r),window._xonBindings||(window._xonBindings=[]);let l=window._xonBindings.findIndex(t=>t.statePath===n);if(l>=0?window._xonBindings[l].target=r:window._xonBindings.push({state:window.state,statePath:n,target:r}),void 0!==window.state[n]){let a=document.querySelectorAll(r);a.forEach(t=>{t.textContent=window.state[n]})}return Reflect.set(t,n,r)}}),console.log("‚úÖ Bind system created:",window.bind)}window.state=new Proxy(window.state,{set(t,n,r){let l=Reflect.set(t,n,r);if(l&&window.bind&&!window.bind[n]){let a=`.${n}-display`,i=document.querySelectorAll(a);i.length>0&&(window.bind[n]=a,console.log("\uD83D\uDD17 Auto-created binding:",n,"‚Üí",a))}return l}}),n.$bind&&Object.entries(n.$bind).forEach(([t,n])=>{console.log("\uD83D\uDD17 Binding:",t,"‚Üí",n),c(l,t,n)})}},m=xon.binder.getNestedProperty||function(t,n){return n.split(".").reduce((t,n)=>t?t[n]:void 0,t)};function f(t,n){window.bind={},Object.entries(n).forEach(([n,r])=>{window.bind[n]=r,window._xonBindings||(window._xonBindings=[]),window._xonBindings.push({state:t,statePath:n,target:r});let l=m(t,n),a=document.querySelectorAll(r);a.forEach(t=>{t.textContent=l})}),window.bind=new Proxy(window.bind,{set(t,n,r){console.log("\uD83D\uDD17 Bind updated:",n,"‚Üí",r),window._xonBindings||(window._xonBindings=[]);let l=window._xonBindings.findIndex(t=>t.statePath===n);if(l>=0?window._xonBindings[l].target=r:window._xonBindings.push({state:window.state,statePath:n,target:r}),void 0!==window.state[n]){let a=document.querySelectorAll(r);a.forEach(t=>{t.textContent=window.state[n]})}return Reflect.set(t,n,r)}}),console.log("‚úÖ Bind system created:",window.bind)}let h=(n,r=null)=>{if(n.startsWith("@")&&n.includes("&"))return u(n);if(n.startsWith("@")&&n.includes("~"))return l(n);if(n.startsWith("@"))return l(n);if(n.startsWith("#"))return a(n);if(n.startsWith("~/"))return i(n);else if(n.startsWith("$")&&!n.startsWith("$state"))return o(n);else if(n.startsWith("%"))return n.includes("~>")?t(n):s(n);else if(n.startsWith(":"))return g(n);return{type:"unknown",value:n}};return{splitTokens:n,parseToken:h,parseEvent:l,parseInclude:a,parseRoute:i,parseFunction:o,parseTemplate:s,parseEventTrigger:u,parseReactivity:g,parseJSONReactivity:d,setupJSONReactivity:p,renderElement:function(t){console.log("\uD83C\uDFAF Auto-rendering XON elements within component:",t),t.hasAttribute("data-xon")&&(console.log("\uD83D\uDD0D Processing component element with data-xon:",t),xon.binder.parse(t));let n=t.querySelectorAll("[data-xon]");console.log(`üîç Found ${n.length} child elements with data-xon in component`),n.forEach((t,n)=>{console.log(`üîç Processing child element ${n} in component:`,t),xon.binder.parse(t)}),console.log("‚úÖ Finished auto-rendering component")},render(){document.querySelectorAll("[data-xon]").forEach((t,n)=>{let r=t.getAttribute("data-xon");if(console.log(`üîç Processing element ${n}:`,{tag:t.tagName,dataXon:r}),r?.trim().startsWith("{")){console.log("\uD83C\uDFAF JSON Reactivity Container detected");try{let l=d(t);p(t,l),console.log("‚úÖ JSON container processed successfully")}catch(a){console.error("‚ùå Error processing JSON container:",a)}}else console.log("\uD83D\uDD27 Token-based syntax - passing to binder"),xon.binder.parse(t)}),console.log("‚úÖ Render completed")}}}(),xon.binder=function(){let t=function(t,n){return n.split(".").reduce((t,n)=>t?t[n]:void 0,t)},n=(t,n,r)=>{let l=n.split("."),a=t;for(let i=0;i<l.length-1;i++)a[l[i]]||(a[l[i]]={}),a=a[l[i]];if(a[l[l.length-1]]=r,console.log("\uD83D\uDD27 Set state property:",n,"=",r),n&&!window._xonBindings?.find(t=>t.statePath===n)){let o=`.${n}-display`,s=document.querySelectorAll(o);s.length>0&&(window._xonBindings||(window._xonBindings=[]),window._xonBindings.push({state:t,statePath:n,target:o}),console.log("\uD83D\uDD17 Auto-created binding for:",n,"‚Üí",o),s.forEach(t=>{t.textContent=r}))}},r=(t,n)=>n.split(".").reduce((t,n)=>t?t[n]:void 0,t),l=t=>{let n=t.match(/^([a-zA-Z_][a-zA-Z0-9_]*)\./);if(n){let r=n[1],l=global[r];if(l&&l.__isReactive)return{stateName:r,stateObj:l,propPath:t.slice(r.length+1)}}return null},a=(t,a)=>{if(t&&t.includes(".")&&1===a.length){let o=l(t);if(o&&o.stateObj&&o.stateObj.__isReactive&&1===parsed.functionArgs.length){let s=E(parsed.functionArgs[0],el,e);console.log("\uD83D\uDD27 Setting state property:",{property:o.propPath,value:s,currentValue:r(o.stateObj,o.propPath)}),n(o.stateObj,o.propPath,s),functionResult=s,i(o.stateName,o.propPath,s),console.log("‚úÖ State assignment completed with binding update");return}}return null},i=(t,n,r)=>{if(console.log("\uD83D\uDD17 updateAllBindings called:",{stateName:t,propPath:n,newValue:r}),!window._xonBindings){console.warn("‚ùå No bindings found - window._xonBindings is undefined");return}console.log("\uD83D\uDD17 Total bindings to check:",window._xonBindings.length),window._xonBindings.forEach((t,l)=>{if(console.log(`üîó Checking binding ${l}:`,t),t.statePath===n){let a=document.querySelectorAll(t.target);console.log(`üîó Found matching binding: ${n} ‚Üí ${t.target} (${a.length} elements)`),a.forEach((t,n)=>{console.log(`üîó Updating element ${n}:`,t),t.textContent=r}),console.log("‚úÖ Binding update completed")}})},o=(t,n,r)=>{switch(r){case"text":t.textContent=n??"";break;case"html":t.innerHTML=n??"";break;case"value":"value"in t&&(t.value=n??"");break;case"show":t.style.display=n?"":"none";break;case"hide":t.style.display=n?"none":"";break;case"class":n&&t.classList.add(n);break;case"attr":"object"==typeof n&&Object.entries(n).forEach(([n,r])=>null==r?t.removeAttribute(n):t.setAttribute(n,r))}},s=(t,n)=>{let l=`${t}.${n}`;console.log("\uD83D\uDD01 Triggering reactivity for:",l),window._xonBindings&&window._xonBindings.forEach(t=>{if(t.statePath===n){let l=r(t.state,t.statePath),a=document.querySelectorAll(t.target);console.log("\uD83D\uDD17 Updating binding:",{property:n,value:l,target:t.target,elements:a.length}),a.forEach(t=>{t.textContent=l})}}),window._xonComputedUpdaters&&window._xonComputedUpdaters.forEach((t,n)=>{console.log(`üîÅ Triggering computed update for: ${n}`),t()}),document.querySelectorAll("[data-xon]").forEach(t=>{let r=t.getAttribute("data-xon");(r?.includes(`{$${n}}`)||r?.includes(`{$${l}}`))&&(console.log("\uD83D\uDD01 Updating template element:",t),xon.binder.parse(t))})},u=(t,n)=>{console.log("\uD83D\uDCCA Processing template directive:",n);let r=n.templateName,l=n.target?document.querySelector(n.target):null;if(!l){xon.debug.warn(`Template target not found: ${n.target}`);return}let a=t.innerHTML;if(!a){xon.debug.warn("No template content found in template tag");return}xon.template.renderTo(r,l,null,n.priority,a),console.log("‚úÖ Template directive processed")},g=(t,n)=>{console.log("\uD83D\uDCCA Processing self template:",n);let r=n.templateName,l=t.querySelector(".template-content")?.innerHTML||t.innerHTML;if(!l){xon.debug.warn("No template content found for self-rendering");return}xon.template.renderTo(r,t,null,n.priority,l),console.log("‚úÖ Self template processed")},c=(t,n)=>{console.log("\uD83D\uDCCA Processing form template:",n),n.templateName,t.addEventListener("submit",r=>{r.preventDefault();let l=new FormData(t),a=Object.fromEntries(l.entries()),i={items:[a],template:Object.keys(a)},o=`temp_${Date.now()}`,s=document.createElement("script");s.id=o,s.type="application/json",s.textContent=JSON.stringify(i),document.body.appendChild(s);let u=t.querySelector(".template-content")?.innerHTML||`<div class="form-result">
                                <h4>Form Data:</h4>
                                ${Object.entries(a).map(([t,n])=>`<p><strong>${t}:</strong> ${n}</p>`).join("")}
                            </div>`;xon.template.renderTo(o,t,null,n.priority,u),setTimeout(()=>{document.body.removeChild(s)},1e3),console.log("‚úÖ Form template processed")})},d=(o,s)=>{console.log("\uD83D\uDD0D EVENT PARSING DEBUG:",{templateName:s.templateName,isFormTemplate:s.isFormTemplate,event:s.event,rawToken:o.getAttribute("data-xon")}),xon.debug.log("Handling event:",s);let u=`xon-${s.event}-${s.functionCall||s.includeFile||s.templateName||"template"}`;if(o[u]){xon.debug.log(`Event already bound: ${u}`);return}if(s.isIncrement&&s.statePropertyPath){console.log("\uD83D\uDD27 Processing increment:",s.statePropertyPath,s.functionArgs[0]);let g=l(s.statePropertyPath,o);if(g){let c=r(g.stateObj,g.propPath)||0,d=s.functionArgs[0],m=Number(c)||0,f="++"===d?m+1:m-1;console.log("\uD83D\uDD27 Incrementing:",{property:g.propPath,from:c,numericValue:m,operator:d,to:f}),n(g.stateObj,g.propPath,f),window._xonBindings&&window._xonBindings.forEach(t=>{if(t.statePath===g.propPath){let n=document.querySelectorAll(t.target);n.forEach(t=>{t.textContent=f}),console.log("\uD83D\uDD17 Direct binding update (increment):",g.propPath,"‚Üí",t.target)}}),xon.binder.triggerTemplate(g.stateName,g.propPath),console.log("‚úÖ Increment completed");return}}if(o[u]=!0,o.addEventListener(s.event,t=>{t.preventDefault(),t.stopPropagation(),console.log("\uD83C\uDFAF Event fired - extracting href now:",{event:s.event,element:o.tagName,href:o.getAttribute("href")});try{let n=null;if(o.hasAttribute("href")){let r=o.getAttribute("href");n="~"+r,console.log("‚úÖ Successfully extracted route from href:",n)}else console.warn("‚ùå No href attribute found during event execution");s.includeFile&&(console.log("\uD83D\uDCC1 Processing include:",s.includeFile,"‚Üí",s.target),v(o,{file:s.includeFile,target:s.target},!0)),n&&(console.log("\uD83D\uDEE3Ô∏è Navigating to route:",n),setTimeout(()=>{xon.router.routeTo(n.slice(1)),console.log("‚úÖ Navigation completed")},50))}catch(l){console.error("‚ùå Event execution error:",l)}}),s.templateName&&s.isFormTemplate){console.log("\uD83D\uDCDD Processing FORM template event:",s.templateName),o.addEventListener(s.event,t=>{t.preventDefault(),t.stopPropagation(),console.log("\uD83D\uDCDD Form template event fired - POPULATING FORM FIELDS");try{let n=null;if(s.templateTarget?(n=document.querySelector(s.templateTarget),console.log("\uD83C\uDFAF Using specified target form:",s.templateTarget,n)):(n=o,"FORM"===o.tagName||(n=o.closest("form"))||(n=o.querySelector("form")),console.log("\uD83C\uDFAF Using current element form:",n)),!n){console.warn("‚ùå No form found for form template");return}console.log("\uD83D\uDCDD Target form found:",n);let r=xon.template.readJSON(s.templateName);if(console.log("\uD83D\uDCDD Template data:",r),!r?.items?.length){console.warn("‚ùå No template data found for:",s.templateName);return}let l=r.items[0];console.log("\uD83D\uDCDD Form data to populate:",l),Object.keys(l).forEach(t=>{let r=l[t],a=n.querySelector(`[name="${t}"]`);a?("INPUT"===a.tagName||"TEXTAREA"===a.tagName||"SELECT"===a.tagName)&&(a.value=r,console.log(`‚úÖ Populated field [${t}] = "${r}"`),a.dispatchEvent(new Event("input",{bubbles:!0})),a.dispatchEvent(new Event("change",{bubbles:!0}))):console.warn(`‚ö†Ô∏è Form field not found: ${t}`)}),console.log("‚úÖ Form populated with template data")}catch(a){console.error("‚ùå Form template population error:",a)}}),console.log(`‚úÖ Bound ${s.event} event for form template population`);return}if(s.templateName){console.log("\uD83D\uDCCA Processing template event:",s.templateName),o.addEventListener(s.event,n=>{n.preventDefault(),n.stopPropagation(),console.log("\uD83C\uDFAF Template event fired:",s.event,s.templateName);try{let r=s.templateTarget||s.target?document.querySelector(s.templateTarget||s.target):o;if(!r){console.warn("‚ùå Template target not found");return}if(console.log("\uD83C\uDFAF Rendering template to:",r),s.templateName.startsWith("!")){let l=s.templateName.slice(1),a=t(global,l);if("function"==typeof a){console.log("\uD83C\uDFAF Calling template function:",l);let i=a();r.innerHTML=i,console.log("‚úÖ Function template executed")}else console.warn("‚ùå Template function not found:",l)}else{let u=s.templateName,g=o.querySelector(".template-content")?.innerHTML;if(!g&&o.classList.contains("output-area")&&(g=o.querySelector(".template-content")?.innerHTML||'<div class="border-b pb-2 mb-2">{$name} - {$email}</div>'),!g){console.warn("‚ùå No template HTML found");return}console.log("\uD83D\uDCCA Template HTML:",g),xon.template.renderTo(u,r,null,!1,g),console.log("‚úÖ Template event processed")}}catch(c){console.error("‚ùå Template event error:",c)}}),console.log(`‚úÖ Bound ${s.event} event for template`);return}if(s.routePath){xon.debug.log(`Processing route from event: ${s.routePath}`),o.addEventListener(s.event,t=>{t.preventDefault(),xon.router.routeTo(s.routePath.slice(1))});return}if(!s.functionCall&&!s.includeFile){xon.debug.warn("Invalid event - no function or include:",s);return}o.addEventListener(s.event,u=>{u.preventDefault(),u.stopPropagation(),xon.debug.log(`Event fired: ${s.event}`,{functionCall:s.functionCall,target:s.target,element:o});try{let g=null;if(s.templateName){console.log("\uD83D\uDCCA Processing template event:",s.templateName);let c=s.templateTarget||s.target?document.querySelector(s.templateTarget||s.target):o;if(c){if(s.templateName.includes("(")){let d=s.templateName.match(/(\w+)\(([^)]*)\)/);if(d){let m=d[1],f=d[2],h=t(global,m);if("function"==typeof h){let b=h(f);c.innerHTML=b,console.log("‚úÖ Function template executed")}}}else{let y=document.querySelector(`[data-xon*="${s.templateName}"]`)?.innerHTML||document.getElementById(`${s.templateName}HTML`)?.innerHTML;y&&(xon.template.renderTo(s.templateName,c,null,s.priority,y),console.log("‚úÖ Event template rendered"))}}}if(s.functionCall&&s.functionCall.startsWith("state.")){console.log("\uD83D\uDD27 PROCESSING STATE ASSIGNMENT:",s.functionCall);let T=window.state,w=s.functionCall.replace("state.","");if(T&&T.__isReactive&&1===s.functionArgs.length){let N=E(s.functionArgs[0],o,null);console.log("\uD83D\uDD27 Setting state property:",{property:w,value:N,currentValue:r(T,w)}),n(T,w,N),g=N,i("state",w,N),console.log("‚úÖ State assignment completed");return}}if(s.functionCall){if(console.log("\uD83D\uDD27 Processing function call:",{functionCall:s.functionCall,args:s.functionArgs,isStateAssignment:s.isStateAssignment}),s.isStateAssignment&&s.statePropertyPath){console.log("\uD83D\uDD27 PROCESSING STATE ASSIGNMENT (via flag):",{property:s.statePropertyPath,value:s.functionArgs[0]});let A=l(s.statePropertyPath);if(A){let x=E(s.functionArgs[0],o,null);n(A.stateObj,A.propPath,x),g=x,xon.binder.triggerTemplate(A.stateName,A.propPath),console.log("‚úÖ State assignment completed via flag");return}}let P=a(s.functionCall,s.functionArgs);if(P){console.log("\uD83D\uDD27 DETECTED STATE ASSIGNMENT (universal):",P);let S=E(s.functionArgs[0],o,u);n(P.stateObj,P.propPath,S),g=S,window._xonBindings&&window._xonBindings.forEach(t=>{if(t.statePath===P.propPath){let n=document.querySelectorAll(t.target);n.forEach(t=>{t.textContent=S}),console.log("\uD83D\uDD17 Direct binding update:",P.propPath,"‚Üí",t.target)}}),xon.binder.triggerTemplate(P.stateName,P.propPath),console.log("‚úÖ State assignment completed via universal detection");return}{let C=t(global,s.functionCall);if(console.log("\uD83D\uDD27 Processing as FUNCTION CALL:",{function:s.functionCall,handlerType:typeof C,args:s.functionArgs}),"function"==typeof C){let $=s.functionArgs.map(t=>E(t,o,u));g=C.apply(global,$),console.log("\uD83D\uDD27 Function result:",g)}else if(s.functionCall.startsWith("state.")){let L=l(s.functionCall);if(L&&1===s.functionArgs.length){let F=E(s.functionArgs[0],o,u);n(L.stateObj,L.propPath,F),g=F,window._xonBindings&&window._xonBindings.forEach(t=>{if(t.statePath===L.propPath){let n=document.querySelectorAll(t.target);n.forEach(t=>{t.textContent=F}),console.log("\uD83D\uDD17 Direct binding update (fallback):",L.propPath,"‚Üí",t.target)}}),xon.binder.triggerTemplate(L.stateName,L.propPath),console.log("‚úÖ State assignment completed (fallback)");return}}}}s.routePath&&(xon.debug.log(`Processing route: ${s.routePath}`),setTimeout(()=>{xon.router.routeTo(s.routePath.slice(1))},0)),s.includeFile&&(xon.debug.log(`Processing include from event: ${s.includeFile}`),v(o,{file:s.includeFile,target:s.target},!0)),s.target&&null!==g&&(xon.debug.log(`Processing target: ${s.target} with result:`,g),p(s.target,g)),s.routePath&&(xon.debug.log(`Processing route: ${s.routePath}`),setTimeout(()=>{xon.router.routeTo(s.routePath.slice(1))},0)),s.target&&null!==g&&(xon.debug.log(`Processing target: ${s.target} with result:`,g),p(s.target,g))}catch(M){xon.debug.error("Event execution error:",M)}}),xon.debug.log(`Successfully bound ${s.event} event`)},p=(t,n,r={})=>{if(!t||null==n){xon.debug.warn("Invalid selector or content for updateTargetElements",{selector:t,content:n});return}try{let l=document.querySelectorAll(t);if(0===l.length){if(xon.debug.warn(`No elements found for selector: "${t}"`),r.createIfMissing&&t.startsWith("#")){let a=document.createElement("div");return a.id=t.slice(1),document.body.appendChild(a),xon.debug.log(`Created missing element: ${t}`),p(t,n,{...r,createIfMissing:!1})}return}l.forEach((l,a)=>{let i=r.operation||"replace";switch(xon.debug.log(`Updating target [${a}] with operation "${i}":`,{selector:t,contentType:typeof n,isElement:n instanceof HTMLElement,isNode:n instanceof Node,content:n}),i){case"append":f(l,n,r);break;case"prepend":h(l,n,r);break;case"before":b(l,n,r);break;case"after":y(l,n,r);break;default:m(l,n,r)}}),xon.debug.log(`Successfully updated ${l.length} element(s) with selector: "${t}"`)}catch(i){if(xon.debug.error(`Error updating target "${t}":`,i),r.fallbackToText){xon.debug.log("Attempting fallback to text content...");try{let o=document.querySelectorAll(t);o.forEach(t=>{t.textContent=String(n)})}catch(s){xon.debug.error("Fallback also failed:",s)}}}},m=(t,n,r)=>{if(n instanceof HTMLElement||n instanceof Node){t.innerHTML="";let l=!1!==r.clone?n.cloneNode(!0):n;t.appendChild(l),xon.debug.log("Replaced with HTML element:",n.tagName||n.nodeName)}else if(T(n))t.innerHTML=n,xon.debug.log("Replaced with HTML string");else if("object"==typeof n&&null!==n)!1!==r.stringifyObjects?(t.textContent=JSON.stringify(n,null,2),xon.debug.log("Replaced with stringified object")):(t.textContent=String(n),xon.debug.log("Replaced with object as string"));else if("function"==typeof n)try{let a=n();p(t,a,r),xon.debug.log("Executed function and used result")}catch(i){t.textContent=`Function error: ${i.message}`,xon.debug.error("Function execution failed:",i)}else r.preserveWhitespace?(t.innerHTML="",t.appendChild(document.createTextNode(String(n)))):t.textContent=String(n),xon.debug.log("Replaced with text content:",n)},f=(t,n,r)=>{if(n instanceof HTMLElement||n instanceof Node){let l=!1!==r.clone?n.cloneNode(!0):n;t.appendChild(l)}else T(n)?t.insertAdjacentHTML("beforeend",n):t.insertAdjacentText("beforeend",String(n))},h=(t,n,r)=>{if(n instanceof HTMLElement||n instanceof Node){let l=!1!==r.clone?n.cloneNode(!0):n;t.insertBefore(l,t.firstChild)}else T(n)?t.insertAdjacentHTML("afterbegin",n):t.insertAdjacentText("afterbegin",String(n))},b=(t,n,r)=>{if(n instanceof HTMLElement||n instanceof Node){let l=!1!==r.clone?n.cloneNode(!0):n;t.parentNode.insertBefore(l,t)}else T(n)?t.insertAdjacentHTML("beforebegin",n):t.insertAdjacentText("beforebegin",String(n))},y=(t,n,r)=>{if(n instanceof HTMLElement||n instanceof Node){let l=!1!==r.clone?n.cloneNode(!0):n;t.parentNode.insertBefore(l,t.nextSibling)}else T(n)?t.insertAdjacentHTML("afterend",n):t.insertAdjacentText("afterend",String(n))},T=t=>"string"==typeof t&&/<([a-z][a-z0-9]*)\b[^>]*>|&[a-z]+;|&#[0-9]+;/i.test(t),v=(t,n,r=!1)=>{if(xon.loaded.js?.includes(n.file)||xon.loaded.css?.includes(n.file)||xon.loaded.components?.has(n.file)||!r&&!n.file)return;let l=n.file,a=l.includes(".");if(console.log("\uD83D\uDCC1 handleInclude called:",{file:l,hasExtension:a,isComponent:!a,target:n.target,element:t,isImmediate:r}),a){let i=xon.path+l,o=l.split(".").pop().toLowerCase(),s=n.target?document.querySelector(n.target):null;if(console.log("\uD83D\uDCC4 Loading FILE:",i,"type:",o),!["js","css","html","php","txt"].includes(o)){s&&(s.innerHTML=`<div class="error-message">File type not allowed: .${o}</div>`);return}if("html"===o||"htm"===o||"php"===o)s?(console.log("\uD83D\uDCC4 Loading HTML file into target (NO AUTO-RENDER):",n.target),fetch(i).then(t=>{if(!t.ok)throw Error(`HTTP ${t.status}`);return t.text()}).then(t=>{let n=xon.security.sanitizeHTML(t);s.innerHTML=n,xon.loaded.components.add(l),console.log("‚úÖ HTML file loaded (not auto-rendered)")}).catch(t=>{console.error("‚ùå Failed to load HTML file:",t),xon.security.loadFromScriptTag(l,s)})):(console.log("\uD83D\uDCC4 Loading HTML file into body (NO AUTO-RENDER)"),fetch(i).then(t=>{if(!t.ok)throw Error(`HTTP ${t.status}`);return t.text()}).then(t=>{let n=xon.security.sanitizeHTML(t);document.body.innerHTML+=n,xon.loaded.components.add(l),console.log("‚úÖ HTML file appended to body (not auto-rendered)")}).catch(t=>{console.error("‚ùå Failed to load HTML file:",t),xon.security.loadFromScriptTag(l,document.body)}));else if("css"===o){if(!xon.loaded.css.has(l)){let u=document.createElement("link");u.rel="stylesheet",u.href=i,document.head.appendChild(u),xon.loaded.css.add(l),console.log("‚úÖ CSS file loaded:",l)}}else if("js"===o&&!xon.loaded.js.has(l)){let g=document.createElement("script");g.src=i,g.onload=()=>{xon.loaded.js.add(l),console.log("‚úÖ JS file loaded:",l)},document.head.appendChild(g)}}else{let c=xon.path+l+".html",d=n.target?document.querySelector(n.target):t;console.log("\uD83C\uDFAF Loading COMPONENT:",c,"into:",d),fetch(c).then(t=>{if(!t.ok)throw Error(`HTTP ${t.status}`);return t.text()}).then(n=>{xon.security.sanitizeHTML(),t.removeAttribute("data-xon"),d.innerHTML=n,console.log("‚úÖ Component loaded into target"+d),xon.parser.renderElement(d)}).catch(n=>{console.error("‚ùå Failed to load component:",n),xon.security.loadFromScriptTag(l,d||t),d?xon.parser.renderElement(d):xon.parser.renderElement(t)})}},w=(t,n)=>{let r=n.target?document.querySelector(n.target):t;if(!r){xon.debug.warn(`Template target not found: ${n.target}`);return}xon.template.renderTo(n.templateName,r,n.formData?t.closest("form"):null,n.priority)},N=(r,a)=>{console.log("\uD83D\uDD27 HANDLE FUNCTION:",a);let i=t(global,a.funcName);if("function"==typeof i){let o=a.args.map(t=>(console.log("\uD83D\uDD27 Processing function arg:",t),E(t,r,null)));console.log("\uD83D\uDD27 Calling function with args:",o);let s=i.apply(global,o);return a.target&&p(a.target,s),s}if(a.functionCall.startsWith("state.")){let u=l(a.functionCall);if(u&&1===a.functionArgs.length){let g=E(a.functionArgs[0],r,e);console.log("\uD83D\uDD27 Setting state property (fallback):",{property:u.propPath,value:g}),n(u.stateObj,u.propPath,g),functionResult=g,window._xonBindings&&window._xonBindings.forEach(t=>{if(t.statePath===u.propPath){let n=document.querySelectorAll(t.target);n.forEach(t=>{t.textContent=g}),console.log("\uD83D\uDD17 Direct binding update (fallback):",u.propPath,"‚Üí",t.target)}}),xon.binder.triggerTemplate(u.stateName,u.propPath),console.log("‚úÖ State assignment completed (fallback)");return}}},E=(n,r,l)=>{if(console.log("\uD83D\uDD27 Processing argument:",n),"++"===n||"--"===n)return console.log("\uD83D\uDD27 Detected increment operator:",n),n;if(n.startsWith('"')&&n.endsWith('"')||n.startsWith("'")&&n.endsWith("'"))return n.slice(1,-1);if("$element"===n)return r;if("$event"===n)return l;if("$document"===n)return document;if(n.startsWith('"')&&n.endsWith('"')||n.startsWith("'")&&n.endsWith("'"))return n.slice(1,-1);if(!isNaN(n)&&""!==n.trim())return Number(n);if("true"===n)return!0;if("false"===n)return!1;if("null"===n)return null;if("undefined"===n)return;let a=t(global,n);return void 0!==a?a:n},A=(t,n)=>{t.addEventListener(n.sourceEvent,()=>{let r=n.target?document.querySelector(n.target):t;r&&r.dispatchEvent(new Event(n.triggerEvent))})},x=(t,n)=>{xon.debug.log(`Handling direct route: ${n.path}`),"A"===t.tagName?(t.href="#",t.addEventListener("click",t=>{t.preventDefault(),xon.router.routeTo(n.path.slice(1))})):t.addEventListener("click",t=>{t.preventDefault(),xon.router.routeTo(n.path.slice(1))}),xon.debug.log(`Route handler attached for: ${n.path}`)},P=t=>{let n=t.getAttribute("data-xon")||"";if(n.trim().startsWith("{")){console.log("\uD83C\uDFAF Processing JSON reactivity");let r=xon.parser.parseJSONReactivity(t);xon.parser.setupJSONReactivity(t,r);return}let l=xon.parser.splitTokens(n);if(xon.debug.log("Parsing element:",t),xon.debug.log(`Raw data-xon: "${n}"`),xon.debug.log(`Split into ${l.length} tokens:`,l),"TEMPLATE"===t.tagName&&n.startsWith("%")){for(let a of l){let i=xon.parser.parseToken(a,t);if(i&&"templateDirective"===i.type){u(t,i);break}}return}if(n.startsWith("%")&&!n.includes("~>")){for(let o of l){let s=xon.parser.parseToken(o);if(s&&"template"===s.type){"FORM"===t.tagName?c(t,s):g(t,s);break}}return}for(let p of l){xon.debug.log(`Processing token: "${p}"`);let m=xon.parser.parseToken(p);if(!m){xon.debug.warn(`Failed to parse token: "${p}"`);continue}switch(xon.debug.log("Parsed result:",m),m.type){case"event":d(t,m);break;case"include":v(t,m,!0);break;case"route":x(t,m);break;case"function":N(t,m);break;case"template":w(t,m);break;case"eventTrigger":A(t,m);break;case"unknown":xon.debug.warn(`Unknown token type: ${p}`)}}};return{parse:P,apply:o,triggerTemplate:s,setupAutoBinding:function(t,n,l){window._xonBindings||(window._xonBindings=[]),window._xonBindings.push({state:t,statePath:n,target:l});let a=r(t,n),i=document.querySelectorAll(l);i.forEach(t=>{t&&(t.textContent=a)}),console.log("\uD83D\uDD17 Auto-binding setup:",n,"‚Üí",l)},setupComputedDOMBinding:function(t,n,r){window._xonComputedBindings||(window._xonComputedBindings=[]);let l={computed:t,target:n,functionName:r,update(){let l=t.value,a=document.querySelectorAll(n);a.forEach(t=>{t&&(t.textContent=l)}),console.log(`üîß Computed update: ${r}() ‚Üí ${n} =`,l)}};window._xonComputedBindings.push(l),l.update();let a=setInterval(l.update,100);window._xonComputedIntervals||(window._xonComputedIntervals={}),window._xonComputedIntervals[r]=a},getNestedProperty:r}}(),xon.template=function(){let t=new Map,n=(n,a,i=null,o=!1,s=null)=>{console.log("\uD83D\uDCCA template.renderTo called:",{name:n,target:a,form:i,pri:o,html:s});let u=xon.byId(n);if(console.log("\uD83D\uDCCA Template data element found:",u),!u){console.error("‚ùå Template data element not found:",n);return}let g=i?{items:[Object.fromEntries(new FormData(i).entries())],template:Array.from(new FormData(i).keys())}:r(n);if(console.log("\uD83D\uDCCA Template data:",g),!g?.items?.length){console.warn("‚ö†Ô∏è No template items found");return}let c=s||t.get(n)||u.innerHTML;console.log("\uD83D\uDCCA Template content length:",c.length),t.has(n)||(t.set(n,c),console.log("\uD83D\uDCCA Template cached:",n)),!g.template&&g.items.length>0&&(g.template=Object.keys(g.items[0]),console.log("\uD83D\uDCCA Auto-detected template keys:",g.template));let d="";g.items.forEach((t,n)=>{let r=c;g.template?.forEach(n=>{if(void 0!==t[n]){let a=r;r=r.replaceAll(`{$${n}}`,l(String(t[n]))),a!==r&&console.log(`üìä Replaced {$${n}} with:`,t[n])}}),d+=r,console.log(`üìä Processed item ${n+1}`)}),console.log("\uD83D\uDCCA Setting target innerHTML, length:",d.length),a.innerHTML=d,console.log("‚úÖ Template rendered successfully to:",a)},r=t=>{let n=xon.byId(t);if(!n)return console.warn("‚ùå JSON element not found:",t),null;try{let r=n.textContent||n.innerText||"";r=r.trim().replace(/,\s*]/g,"]").replace(/,\s*}/g,"}").replace(/([{,]\s*)([a-zA-Z0-9_]+)(\s*:)/g,'$1"$2"$3');let l=JSON.parse(r);if(l.items&&Array.isArray(l.items))!l.template&&l.items.length>0&&(l.template=Object.keys(l.items[0]));else if(Array.isArray(l)){let a=l.length>0?Object.keys(l[0]):[];return{items:l,template:a}}return l}catch(i){return console.error("‚ùå JSON parse error:",i),null}},l=t=>String(t).replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t]),a=(n,a,i=100)=>{let o=r(n),s=t.get(n)||xon.byId(n)?.innerHTML;if(!o?.items||!a||!s){console.warn("‚ö†Ô∏è Cannot render large template - missing data or target");return}let u=o.items.length,g=0,c="",d=()=>{let t=Math.min(g+i,u);for(let n=g;n<t;n++){let r=s,p=o.items[n];o.template?.forEach(t=>{void 0!==p[t]&&(r=r.replaceAll(`{$${t}}`,l(String(p[t]))))}),c+=r}a.innerHTML=c,(g=t)<u&&requestAnimationFrame(d)};d()},i=(t,n)=>{let l=r(n);if(!l?.items?.length){console.warn("‚ö†Ô∏è No data found for form population");return}let a=l.items[0];Object.keys(a).forEach(n=>{let r=a[n],l=t.querySelector(`[name="${n}"]`);l&&("INPUT"===l.tagName||"TEXTAREA"===l.tagName||"SELECT"===l.tagName)&&(l.value=r,console.log(`üìä Set form field [name="${n}"] = "${r}"`))})},o=(n=null)=>{n?(t.delete(n),console.log("\uD83D\uDCCA Cleared cache for:",n)):(t.clear(),xon.debug.log("\uD83D\uDCCA Cleared all template cache"))};return{renderTo:n,renderLarge:a,populateForm:i,clearCache:o,cache:t,readJSON:r,sanitize:l}}(),xon.router=function(){let t=!0,n=window.location.pathname,r=(r,l="")=>{if(!t)return;let a=r.startsWith("/")?r:"/"+r;n=a,history.pushState({path:a},l||document.title,a),dispatchEvent(new CustomEvent("xonroutechange",{detail:{path:a}}))};return{init(){n=window.location.pathname,window.addEventListener("popstate",t=>{t.state?.path&&(n=t.state.path,dispatchEvent(new CustomEvent("xonroutepopstate",{detail:t.state})))})},routeTo(t,n){r(t,n)},getCurrent:()=>n,enable(n=!0){t=!!n}}}(),xon.dom=function(){let t=new Map,n=n=>(t.has(n)||t.set(n,document.querySelectorAll(n)),t.get(n));return{all:n,addClass(t,n){n.classList.add(t)},removeClass(t,n){n.classList.remove(t)},toggleClass(t,n){n.classList.toggle(t)}}}(),window.xon=xon,window.xonRegister=xon.registry.registerFunction.bind(xon.registry),window.xonRegisterVar=xon.registry.registerVariable.bind(xon.registry),window.xonRegisterClass=xon.registry.registerClass.bind(xon.registry),window.xonAllowNamespace=t=>xon.security.allowed.add(t),window.xonRegisterNamespace=t=>{window[t]&&xon.registry.scanObj(window[t],t)};let start=performance.now();document.addEventListener("DOMContentLoaded",()=>{xon.init();let t=performance.now()-start;xon.debug.warn(`XON initialised in ${t.toFixed(2)} ms (${(t/1e3).toFixed(3)} seconds)`)})}(window);
